# Discord Role Application Bot

Discordサーバー向けの認証申請・ロール付与管理Botです。ユーザーからの申請を受け付け、管理者が承認・却下を行い、ロールを自動付与する機能を提供します。

## 目次

*   [主な機能](#主な機能)
*   [セットアップ方法](#セットアップ方法)
*   [環境変数](#環境変数)
*   [必要なDiscord Gateway Intents](#必要なdiscord-gateway-intents)
*   [Botに必要な権限](#botに必要な権限)
*   [実行方法](#実行方法)
    *   [ビルド & 起動 (通常)](#ビルド--起動-通常)
    *   [開発モード](#開発モード)
*   [コマンド一覧](#コマンド一覧)
    *   [/auth (管理者・認証担当向け)](#auth-管理者認証担当向け)
    *   [/manage_role (管理者向け)](#manage_role-管理者向け)
*   [ログ](#ログ)
*   [免責事項](#免責事項)
*   [ライセンス](#ライセンス)

## 主な機能

*   **認証パネル作成**: チャンネルに申請開始ボタン付きのパネルを設置。
*   **モーダル入力**: 申請時にユーザーに質問（最大5問）を表示し、回答を収集。
*   **承認フロー**: 通知チャンネルに申請が届き、管理者がボタンで「承認（ロール付与）」または「却下（理由入力）」を選択。
*   **ロール管理**: 承認時に付与するロールをメニューから選択可能（複数可）。
*   **権限チェック**: Botや操作ユーザーより上位のロールは操作できない安全設計。
*   **履歴管理**: ユーザーごとの過去の申請履歴（承認/却下/キャンセル）を確認可能。
*   **ブラックリスト**: 特定ユーザーの申請をブロック。
*   **申請キャンセル**: パネル上のボタンから、ユーザー自身が申請を取り下げ可能。
*   **承認時DM通知**: 申請承認時に、承認されたユーザーへBotからDMで通知。
*   **多言語対応 (i18n)**:
    *   **ユーザーロケール**: エフェメラルな応答やエラーメッセージは、操作したユーザーのDiscordクライアント言語で表示。
    *   **サーバーロケール**: 認証パネルやログ、公開メッセージは、サーバーのDiscord設定言語で表示。
*   **履歴自動整理**: ユーザーごとの申請履歴が30件を超えた場合、古いものから自動的に削除し、履歴データを適正に保ちます。

## セットアップ方法

1. **リポジトリのクローン**:
    ```bash
    git clone https://github.com/SAN-Tyoku/discord_roles_bot.git
    cd discord_roles_bot
    ```

2. **依存関係のインストール**:
    ```bash
    npm install
    ```

3. **スラッシュコマンドの登録**:
    botがDiscordサーバーでスラッシュコマンド (`/auth` など) を利用できるように登録します。
    このコマンドはbot起動前に一度実行する必要があります。

    ```bash
    npm run deploy
    ```

4. **環境変数の設定**:
    プロジェクトルートに `.env` ファイルを作成します。`.env.example` を参考に、必要な情報を入力してください。
    ```bash
    cp .env.example .env
    ```

## 環境変数

`.env` ファイルに以下の変数を設定してください。

| 変数名 | 説明 | 設定値の例 |
| :--- | :--- | :--- |
| `BOT_TOKEN` | Discord Bot Token | `MTI3...` |
| `APPLICATION_ID` | Discord Application ID | `1234567890...` |
| `LOG_LEVEL` | ログ出力レベル | `info`, `debug`, `warn`, `error` |
| `NODE_ENV` | 実行環境 | `development` (コンソール出力あり) / `production` (ファイル出力のみ) |

## 必要なDiscord Gateway Intents

Botのコード内では以下のIntentsを使用しています。Discord Developer Portalでの「Privileged Gateway Intents」の有効化は、基本機能においては**必須ではありません**。

*   `Guilds` (サーバー情報の取得)
*   `GuildMessages` (メッセージの操作)

※ メンバー情報の取得は都度API経由で行うため、`Server Members Intent` は無効でも動作するように設計されています。

## Botに必要な権限

Botをサーバーに招待する際、またはBotのロールに対して、以下の権限を付与してください。

1.  **ロールの管理 (Manage Roles)**
    *   承認時にユーザーにロールを付与するために**必須**です。
    *   **重要**: Discordの仕様上、Botは「Bot自身のロールより下位のロール」しか付与できません。サーバー設定でBotのロールを、付与対象のロールよりも上に配置してください。
2.  **メッセージを送信 (Send Messages)**
    *   パネルの設置や通知の送信に必須です。
3.  **埋め込みリンク (Embed Links)**
    *   リッチなメッセージ表示（Embed）に必須です。
4.  **チャンネルを見る (View Channel)**
    *   設置先および通知先のチャンネルで見えている必要があります。

## 実行方法

### ビルド & 起動 (通常)
```bash
npm start
```
※ TypeScriptのコンパイル(`npm run build`)が行われ、`dist/index.js`が実行されます。
※ 初回起動時にデータベース（`database.sqlite`）が自動生成され、スラッシュコマンドがDiscordに登録されます。

### 開発モード
```bash
npm run dev
```
※ `ts-node` を使用してTypeScriptファイルを直接実行します。

### コード品質チェック

開発中にコードの品質とスタイルを維持するために、ESLintとPrettierを設定しています。

*   **Lintの実行:**
    ```bash
    npm run lint
    ```
    コードの問題点やスタイル違反を検出します。
*   **コードの自動整形:**
    ```bash
    npm run format
    ```
    Prettierを使用してコードを自動的に整形します。コミット前に実行することをお勧めします。

## コマンド一覧

### `/auth` (管理者・認証担当向け)
認証システム全般を管理するメインコマンドです。

*   **`setup`**: 認証パネルを作成・設置します。
*   **`channel`**: 申請が届く「通知チャンネル」を設定します（必須）。
*   **`modal`**: 申請時の質問内容を設定します（最大5問）。
*   **`status`**: 現在の設定、申請件数、システム稼働状況を表示します。
*   **`config`**: 現在の設定（通知先、設置場所、質問内容）を表示します。
*   **`history [user]`**: 指定したユーザーの過去の申請履歴を表示します。
*   **`blacklist`**:
    *   `add [user] [reason]`: ユーザーをブラックリストに追加します。
    *   `remove [user]`: ユーザーをブラックリストから削除します。
    *   `list`: ブラックリスト一覧を表示します。
*   **`dm_notification [enable]`**:
    *   承認時のDM通知の有効(`True`)・無効(`False`)を切り替えます。

### `/manage_role` (管理者向け)
手動でロールを付与・削除する補助コマンドです。

*   **`user`**: 対象ユーザー
*   **`role`**: 対象ロール
*   **`action`**: `付与` または `削除`

## ログ

Botの稼働ログは `logs/` ディレクトリに保存されます。

*   **`logs/combined.log`**: 全てのログ（情報、警告、エラー）
*   **`logs/error.log`**: エラーログのみ

環境変数 `NODE_ENV` が `development` の場合は、コンソール（ターミナル）にもログが出力されます。

## 免責事項
このBotは、学生が「自分が使えればヨシ！」という勢いで作った、よくわかんないBotです。
コードはたぶん真面目に書いていますが、長期的な保守やサポートは全く保証しません(時間と気力があれば対応するかも、くらいの温度感です)。
もし動かなくなっても文句は言わないでね☆
オープンソースなので、自由にフォークして直して使ってもらう分には大歓迎です！

## ライセンス

本プロジェクトは [MIT License](../LICENSE) の下で公開されています。詳細については [LICENSE](../LICENSE) ファイルを参照してください。